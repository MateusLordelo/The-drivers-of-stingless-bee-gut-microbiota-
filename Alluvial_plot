

# Load packages
library(dplyr)
library(ggplot2)
library(ggalluvial)

# Step 1: calculate relative abundance at Genus × Age × Species level
rel_abund <- ps_melted %>%
  filter(Age %in% c("Larva", "Nurse", "Forrager")) %>%
  group_by(sample_Species, Age, Genus) %>%
  summarise(MeanAbundance = mean(Abundance), .groups = "drop") %>%
  group_by(sample_Species, Age) %>%
  mutate(RelAbundance = MeanAbundance / sum(MeanAbundance)) %>%
  ungroup()

# Step 2: Define the list of genera to plot
genera_to_plot <- c(
  "Erysipelatoclostridium", "Ameyamaea", "Lactobacillus", "Pseudomonas",
  "Anthococcus", "Bifidobacterium", "Snodgrassella", "Prevotella_7",
  "Commensalibacter", "Fructobacillus"
)

# Step 3: collapse other genera
rel_abund <- rel_abund %>%
  mutate(Genus_collapsed = ifelse(Genus %in% genera_to_plot, Genus, "Other"))

# Step 4: re-aggregate after collapsing
rel_abund <- rel_abund %>%
  group_by(sample_Species, Age, Genus_collapsed) %>%
  summarise(RelAbundance = sum(RelAbundance), .groups = "drop")

# Step 5: Order the genera so "Other" is at the bottom of the plot
# First, get the unique genera in the order you want, with "Other" first
genus_order <- c("Other", sort(unique(rel_abund$Genus_collapsed[rel_abund$Genus_collapsed != "Other"])))

# Convert to a factor with the desired order
rel_abund$Genus_collapsed <- factor(rel_abund$Genus_collapsed, levels = genus_order)

# Make sure to follow the order "larva -> nurse -> forager"
rel_abund$Age <- factor(rel_abund$Age,
                        levels = c("Larva", "Nurse", "Forrager"))

# -----------------
# Function to plot alluvial
plot_alluvial <- function(df, species_label = "Both species") {
  ggplot(df,
         aes(x = Age, stratum = Genus_collapsed, alluvium = Genus_collapsed,
             y = RelAbundance, fill = Genus_collapsed)) +
    geom_flow(stat = "alluvium", lode.guidance = "forward", color = "darkgray") +
    geom_stratum() +
    # Assuming 'colors' object is defined in your environment
    scale_fill_manual(values = colors, drop = FALSE) +
    labs(title = paste("Alluvial plot of select genera —", species_label),
         y = "Relative abundance", x = "Life stage") +
    theme_minimal(base_size = 15) +
    theme(legend.position = "right")
}

# -----------------
# Plot 1: both species pooled
df_both <- rel_abund %>%
  group_by(Age, Genus_collapsed) %>%
  summarise(RelAbundance = mean(RelAbundance), .groups = "drop")
p_both <- plot_alluvial(df_both, "Both species")

# Plot 2: M. mondury
df_mondury <- rel_abund %>% filter(sample_Species == "M_mondury")
p_mondury <- plot_alluvial(df_mondury, "M. mondury")

# Plot 3: M. capixaba
df_capixaba <- rel_abund %>% filter(sample_Species == "M_capixaba")
p_capixaba <- plot_alluvial(df_capixaba, "M. capixaba")

# Show them
p_both
p_mondury
p_capixaba
